<form action="{:sysuri()}" class='layui-form layui-card' data-auto="true" data-table-id="DataTable" method="post">

    <div class="layui-card-body padding-left-40">

        <div class="layui-form-item block relative">
            <span class="help-label label-required-prev"><b>供应商</b></span>
            <select name="supplier_gid" lay-search>
                <option value="">请选择</option>
                {foreach $suppliers as $gid=>$title}{if isset($vo.supplier_gid) && $gid eq $vo.supplier_gid}}
                <option value="{$gid}" selected>{$title}</option>
                {else}
                <option value="{$gid}">{$title}</option>
                {/if}
                {/foreach}
            </select>
        </div>
        <div class="layui-form-item block relative">
            <span class="help-label label-required-prev"><b>入库单</b></span>
            <div class="layui-input-group" data-show-in-iframe>
                <div class="layui-input color-desc pointer" id="in_stock_sns">{$vo.in_stock_sns|default='选择入库单'}</div>
                <input type="hidden" name="in_stock_sns" value="{$vo.in_stock_sns|default=''}">
                <div class="layui-input-split layui-input-suffix" style="cursor: pointer;">
                    <i class="layui-icon layui-icon-search"></i>
                </div>
            </div>
            <div class="color-desc" id="sn_list"></div>
        </div>
        <div class="layui-form-item block relative">
            <span class="help-label"><b>合计应付款金额</b></span>
            <div class="layui-input layui-disabled" id="un_paid_amount">{$vo.un_paid_amount|default="0"}</div>
        </div>
        <div class="layui-form-item block relative">
            <span class="help-label label-required-prev"><b>支付方式</b></span>
            <select name="pay_type">
                <option value="">请选择</option>
                {foreach :config("a.pay_out_types") as $k=>$v}{if isset($vo.pay_type) && $k eq $vo.pay_type}}
                <option value="{$k}" selected>{$v}</option>
                {else}
                <option value="{$k}">{$v}</option>
                {/if}
                {/foreach}
            </select>
        </div>

        <label class="layui-form-item block relative">
            <span class="help-label"><b>实际付款金额</b></span>
            <input class="layui-input" name="money" type="number" min="0" required placeholder="请输入付款金额" value='{$vo.money|default=""}'>
            <div class="color-desc">付款金额不能大于入库单合计应付款金额，审核通过后，将按入库单的审核时间，依次核销</div>
        </label>

        <div class="layui-form-item block relative">
            <span class="help-label"><b>付款凭证图片</b></span>
            <div>
                <input type="hidden" name="images" value="{$vo.images|default=''}">
                <script>$("[name=images]").uploadMultipleImage();</script>
            </div>
        </div>


        <label class="layui-form-item block relative">
            <span class="help-label"><b>备注</b></span>
            <textarea class="layui-textarea" name="remark" placeholder="请输入备注">{$vo.remark|default=''}</textarea>
        </label>
    </div>

    <div class="hr-line-dashed"></div>
    {notempty name='vo.id'}<input name='id' type='hidden' value='{$vo.id}'>{/notempty}
    <input name='sn' type='hidden' value='{$vo.sn|default=""}'>
    <div class="layui-form-item text-center">
        <button class="layui-btn" type='submit'>保存数据</button>
        <button class="layui-btn layui-btn-danger" data-close data-confirm="确定要取消编辑吗？" type='button'>取消编辑</button>
    </div>
</form>
<script>

    (function(){
        let sns = "{$vo.in_stock_sns|default=''}";
        let html = [];
        sns.split(",").forEach(sn=>{
            html.push(`<a data-modal="{:url('stock.instock/detail')}?id=${sn}" data-full="1" data-title="查看入库单">${sn}</a>`);
        })
        html = "入库单号：" + html.join(", ");
        $("#sn_list").html(html);
    })();

    $.base.onEvent("click", "[data-show-in-iframe]", ()=>{
        let $input = $("[name=supplier_gid]");
        let first = $input.next().find("dl>dd.layui-this").first()
        let sgid = first.attr("lay-value");
        let stitle = first.text();
        if(!sgid) return $.msg.error("选择入库单前，请先选择供应商");
        $.vandles.iframe("{:url('stock.instock/select4payout')}?is_multi=1&sgid="+sgid, {title: "选择入库单 - " + stitle, width: "1000px"})
    });

    // 选择入库单
    function setInStocks(sns){
        let html = [];
        sns.forEach(sn=>{
            html.push(`<a data-modal="{:url('stock.instock/detail')}?id=${sn}" data-full="1" data-title="查看入库单">${sn}</a>`);
        })
        sns = sns.join(',');
        html = "入库单号：" + html.join(", ");

        $("#in_stock_sns").text(sns);
        $("[name=in_stock_sns]").val(sns);
        $("#sn_list").html(html);

        // 合计应付款金额
        $.get(`{:url('stock.instock/getUnPaidAmount')}?sns=${sns}`).then(res=>{
            if(res.code != 1) return $.msg.error(res.info||"系统错误");
            $("#un_paid_amount").text(res.data.amount||"");
        });
    }


</script>