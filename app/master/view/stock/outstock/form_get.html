<style>
    .layui-disabled, .layui-disabled:hover {
        color: #999 !important;
    }
</style>
<form action="{:sysuri()}" class='layui-form layui-card' id="subs-form" data-auto="true" data-table-id="DataTable"
      method="post">

    <div class="layui-card-body padding-left-40">
        <div class="layui-row layui-col-space10">
            <div class="layui-col-sm3"><span class="help-label"><b>出库单号</b></span>
                <div class="layui-form-item">
                    <div class="layui-input layui-disabled">{{vo.sn || "自动生成"}}</div>
                </div>
            </div>
            <div class="layui-col-sm3"><span class="help-label"><b>出库方式</b></span>
                <div class="layui-form-item">
                    <div class="layui-input layui-disabled">{{vo.out_stock_type_txt || "自动生成"}}</div>
                </div>
            </div>
        </div>
        <div class="layui-row layui-col-space10">
            <div class="layui-col-sm6"><span class="help-label"><b>备注</b></span>
                <textarea class="layui-textarea" name="remark" style="min-height:70px;" v-model="vo.remark" placeholder="请输入备注"></textarea>
            </div>
        </div>
        <div class="layui-row layui-col-space10">
            <div><b>明细列表</b></div>
            <table class="layui-table">
                <tr>
                    <td colspan="6">
                        <button class="layui-btn layui-btn-xs" type="button" @click="showGoodsSelect">添 加</button>
                        <button class="layui-btn layui-btn-xs layui-btn-primary" type="button" @click="showBatchNum">统一数量</button>
                    </td>
                </tr>
                <tr>
                    <th>商品名称</th>
                    <th>商品规格</th>
                    <th>商品单位</th>
                    <th class="w120px">商品数量</th>
                    <th class="text-center" style="width:50px">操作</th>
                </tr>
                <tr v-for="(item,index) in subs" :key="item.goods_sn">
                    <td>{{item.goods_name}}</td>
                    <td>{{item.goods_spec}}</td>
                    <td>{{item.goods_unit}}</td>
                    <td class="table-input-edit">
                        <input class="layui-input" type="number" min="0" @blur="goodsNumberChange(index)" v-model="item.goods_number">
                    </td>
                    <td class="text-center">
                        <button class="layui-btn layui-btn-xs layui-btn-danger" type="button" @click="subDel(index)">删除</button>
                    </td>
                </tr>
                <tr v-if="subs.length > 0">
                    <td colspan="6" class="text-right font-w7"><span>合计总数量: {{vo.total || 0}}</span></td>
                </tr>
                <tr v-else>
                    <td class="text-center" colspan="6">暂无数据</td>
                </tr>
            </table>
        </div>
    </div>
    <div class="hr-line-dashed margin-tb-20"></div>
    <div class="layui-form-item text-center" style="z-index: 99;">
        {if isset($vo.id)}<input name='id' type='hidden' value='{$vo.id}'>{/if}
        <button class="layui-btn" type='button' @click="submit">保存数据</button>
        <button class="layui-btn layui-btn-danger" data-close type='button'>关闭窗口</button>
    </div>
</form>
<script>
    // let $vm;
    require(['vue'], function (Vue) {
        let that;
        $subsVm = new Vue({
            el: '#subs-form',
            data() {
                return {
                    vo: {},
                    subs: []
                }
            },
            mounted() {
                that = this;
                this.vo = JSON.parse('{$vo|default=[]|json_encode|raw}');
                this.subs = JSON.parse('{$subs|default=[]|json_encode|raw}');
            },
            updated() {
                layui.form.render();
            },
            methods: {
                calcTotal() {
                    let total = 0, amount = 0;
                    for (let i in this.subs) {
                        if (!this.subs[i].goods_number) continue;
                        total += +this.subs[i].goods_number;
                    }
                    this.$set(this.vo, "total", Math.round(total, 3).toFixed(3))
                },
                goodsNumberChange(index) {
                    this.calcTotal();
                },
                showGoodsSelect() {
                    $.vandles.iframe("{:url('product.goods/select')}?is_multi=1&goods_type=1", {title: "添加原料", width: "1000px"})
                },
                // 批量设置数量
                showBatchNum(){
                    if(!this.subs.length) return $.msg.tips("请先选择原材料");
                    let idx = layui.layer.prompt({title:"请输入数量"}, (txt)=>{
                        if(!this.subs.length) return;
                        let num = parseFloat(txt);
                        if(isNaN(num)) return $.msg.tips("请输入正确的数字");
                        if(num <= 0) return $.msg.tips("请输入大于0的数字");
                        for (let i in this.subs) {
                            this.subs[i].goods_number = txt;
                        }
                        this.calcTotal();
                        this.$forceUpdate();
                        layui.layer.close(idx);
                    });
                },
                subAdd(goods) {
                    for (let i in this.subs) {
                        if (this.subs[i].goods_sn == goods.goods_sn) {
                            let error = '商品已存在，请直接修改数量: ' + goods.goods_name;
                            $.msg.tips(error);
                            throw error
                        }
                    }
                    this.subs.push(goods);
                },
                subAddList(list){
                    if(this.subs.length == 0) return this.subs = list;
                    for (let i in list) {
                        let goods = list[i];
                        let isDuplicate = false;
                        for (let j in this.subs) {
                            if (this.subs[j].goods_sn == goods.goods_sn) {
                                let error = '商品已存在，请直接修改数量: ' + goods.goods_name;
                                $.msg.tips(error);
                                isDuplicate = true;
                                break;
                            }
                        }
                        if (!isDuplicate) this.subs.push(goods);
                    }
                },
                subDel(index) {
                    $.msg.confirm("确定要删除吗？", () => {
                        this.subs.splice(index, 1);
                        this.calcTotal();
                    })
                },
                submit() {
                    if (!this.validate()) return;

                    let params = {
                        sn: this.vo.sn,
                        out_stock_type: this.vo.out_stock_type || 'sale',
                        remark: this.vo.remark || '',
                        subs: this.subs,
                    }
                    $.post("{:sysuri()}", params).then(res => {
                        if (res.code != 1) return $.msg.error(res.info || "系统错误");
                        $.msg.success(res.info || "操作成功");
                        $.msg.closeThisModal("#subs-form");
                        // $('#DataTable').trigger('reload');
                        $.form.reload();
                    })
                },
                validate() {
                    if (this.subs.length == 0) return $.msg.error("请添加商品明细") === null;
                    for (let i in this.subs) {
                        let item = this.subs[i];
                        if (!item.goods_number || item.goods_number <= 0) {
                            let error = "请输入商品数量: " + item.goods_name
                            $.msg.error(error);
                            throw error;
                        }
                    }
                    return true;
                }
            }
        })
    });

    // 选择商品
    function setGoods(goods_sn) {
        $.get(`{:url('product.goods/getGoodsBySn')}?sn=${goods_sn}&p=1`).then(res => {
            if (res.code != 1) return $.msg.error(res.info || "系统错误");
            $subsVm.subAddList(res.data.goods);
        });
    }

    // 导出excel
    function exportFile(obj) {
        let items = [], colWidth = [];
        // 1. 表头数据
        let headers = ["生产日期", "时间段", "商品名称", "商品单位", "生产规格", "计划数量", "实际数量"];
        // 工序操作者
        for (let p of processList) {
            headers.push(p.title);
        }
        headers.push("备注");

        items.push(headers);

        // 2. 表体数据
        layui.table.getData(obj.config.id).forEach(function (item) {
            let row = [
                item.date_week,
                item.time_slot_txt,
                item.goods_name,
                item.goods_unit,
                item.goods_spec,
                item.plan_number,
                item.actual_number,
            ];
            for (let p of processList) {
                row.push(item[`producer${p.id}_ids_txt`]);
            }
            row.push(item.remark);
            items.push(row);
        });

        // 3. 导出文件
        let date = layui.util.toDateString(Date.now(), '_yyyyMMdd_HHmmss');
        let title = `{$title|default=''}_${date}`
        $.vandles.exportExcle({items, colWidth}, title);
    }

    $.base.onEvent("click", "[data-reject]", function () {
        let remarkElem = $("[name=pass_remark]");
        let passRemark = remarkElem.val();
        if (!passRemark) {
            remarkElem.css({"border-color": "red"});
            remarkElem.off("blur").on("blur", function () {
                remarkElem.css({"border-color": ""});
            });
            return $.msg.error("请在审核备注栏填写驳回原因");
        }
        $.msg.confirm(this.dataset.confirm, () => {
            $.post("{:sysuri()}", {"pass_remark": passRemark, id: "{$vo.id|default=''}"}).then(res => {
                if (res.code != 1) return $.msg.error(res.info || "系统错误");
                $.msg.success(res.info, 2, () => {
                    $.form.reload();
                    $.msg.closeThisModal("#subs-form");
                });
            });
        });
    });

</script>
<script type="text/html" id="inlinebarSubs">
    {{# if(d.status == 0){ }}
    <button class="layui-btn layui-btn-xs" type="button" lay-event="subEdit">编 辑</button>
    <button class="layui-btn layui-btn-xs layui-btn-danger" type="button" lay-event="subDel">删 除</button>
    {{# } }}
</script>
<script type="text/html" id="toolbarSubs">
    <button class="layui-btn layui-btn-xs layui-btn-primary" type="button" lay-event="subAdd">添 加</button>
    <!-- <button class="layui-btn layui-btn-xs layui-btn-primary" type="button" lay-event="subReload">刷 新</button> -->
    <!-- <button class="layui-btn layui-btn-xs layui-btn-danger" type="button" lay-event="subDel">删除</button> -->
</script>