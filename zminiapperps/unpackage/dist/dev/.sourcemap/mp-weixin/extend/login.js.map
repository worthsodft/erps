{"version":3,"file":"login.js","sources":["extend/login.js"],"sourcesContent":["// import store from '@/store/index.js'\r\nexport default{\r\n\t// 获取登录用的code\r\n\tgetCode(cb){\r\n\t\t// #ifdef MP-WEIXIN\r\n\t\tuni.login({\r\n\t\t\tsuccess(res) {\r\n\t\t\t\tcb && cb(res.code);\r\n\t\t\t}\r\n\t\t});\r\n\t\t// #endif\r\n\t\t// #ifdef H5\r\n\t\tconst info = uni.getSystemInfoSync();\r\n\t\t// const info = null;\r\n\t\t// info.deviceId = \"obzAZ7c85NvxGhEXyOEXnP6uY0JM\" // 纵横四海\r\n\t\t// info.deviceId = \"obzAZ7eSb81qMLsW-4Lor6oPlkU4\" // 英雄本色\r\n\t\t\r\n\t\tcb && cb(info.deviceId||\"asdfasdf123123\")\r\n\t\t// #endif\r\n\t},\r\n\t// 登录\r\n\tdo(pid, cb){\r\n\t\treturn new Promise((resolve, reject)=>{\r\n\t\t\tthis.getCode(async code=>{\r\n\t\t\t\t// #ifdef MP-WEIXIN\r\n\t\t\t\tconst res = await uni.$http.post('v1/login',{code,pid});\r\n\t\t\t\t// #endif\r\n\t\t\t\t// #ifdef H5\r\n\t\t\t\tconst res = await uni.$http.post('v1/loginH5',{openid:code,pid})\r\n\t\t\t\t// #endif\r\n\t\t\t\tcb && cb(res)\r\n\t\t\t\tif(res.code == 1){\r\n\t\t\t\t\tthis.updateTokenCache(res.data)\r\n\t\t\t\t\tresolve(res.data.token)\r\n\t\t\t\t}else{\r\n\t\t\t\t\treject()\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t},\r\n\tupdateTokenCache(data){\r\n\t\tuni.$tool.cache(\"token\", data.token)\r\n\t\tuni.$tool.cache(\"expire_at\", data.expire_at)\r\n\t\tuni.$tool.cache(\"expire_at_txt\", data.expire_at_txt)\r\n\t\tuni.$tool.cache(\"is_phone\", data.is_phone)\r\n\t},\r\n\t\r\n\t// 判断是否已登录\r\n\tasync judgeLogin(cb){\r\n\t\tconst token = uni.$tool.cache(\"token\");\r\n\t\tconst expire_at = uni.$tool.cache(\"expire_at\");\r\n\t\tif(!token || Date.now()/1000 > expire_at){\r\n\t\t\tawait this.do();\r\n\t\t\tconsole.log('login.do(登录)');\r\n\t\t\tcb && cb();\r\n\t\t\treturn Promise.resolve()\r\n\t\t}else{\r\n\t\t\tcb && cb();\r\n\t\t\treturn Promise.resolve()\r\n\t\t}\r\n\t},\r\n\t\r\n\tjudgePhone(cb){\r\n\t\tthis.judgeLogin(()=>{\r\n\t\t\tconst token = uni.$tool.cache(\"token\");\r\n\t\t\tconst is_phone = uni.$tool.cache(\"is_phone\");\r\n\t\t\tif(is_phone){\r\n\t\t\t\tcb && cb();\r\n\t\t\t}else{\r\n\t\t\t\tuni.$tool.alert(\"请先完善用户信息\",()=>{\r\n\t\t\t\t\tuni.$tool.navto(\"/pages/my/form\")\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t})\r\n\t},\r\n\t\r\n\tlogout(){\r\n\t\tuni.$tool.removeCache(\"token\")\r\n\t\tuni.$tool.removeCache(\"expire_at\")\r\n\t\tuni.$tool.removeCache(\"expire_at_txt\")\r\n\t\tuni.$tool.removeCache(\"is_phone\")\r\n\t},\r\n\t\r\n\t// 获取绑定手机号码\r\n\t// getPhone(params, code=null){\r\n\t// \treturn new Promise((resolve,reject)=>{\r\n\t// \t\tif(!code){\r\n\t// \t\t\tthis.getCode(code=>{\r\n\t// \t\t\t\tparams.code = code\r\n\t// \t\t\t\tthis.postPhone(params).then(res=>{ resolve(res) })\r\n\t// \t\t\t})\r\n\t// \t\t}else{\r\n\t// \t\t\tparams.code = code\r\n\t// \t\t\tthis.postPhone(params).then(res=>{ resolve(res) })\r\n\t// \t\t}\r\n\t// \t})\r\n\t// },\r\n\t// 请求后台api\r\n\t// postPhone(params){\r\n\t// \treturn new Promise((resolve,reject)=>{\r\n\t// \t\tuni.$u.http.post(pv + '/savePhone', params, {custom:{auth:false}}).then(res=>{\r\n\t// \t\t\tif(res.code == 1){\r\n\t// \t\t\t\tstore.commit('updateToken', res.data)\r\n\t// \t\t\t\tresolve(res.data.userInfo)\r\n\t// \t\t\t}\r\n\t// \t\t})\r\n\t// \t})\r\n\t// }\r\n}"],"names":["uni"],"mappings":";;AACA,MAAc,QAAA;AAAA;AAAA,EAEb,QAAQ,IAAG;AAEVA,kBAAAA,MAAI,MAAM;AAAA,MACT,QAAQ,KAAK;AACZ,cAAM,GAAG,IAAI,IAAI;AAAA,MACjB;AAAA,IACJ,CAAG;AAAA,EAUD;AAAA;AAAA,EAED,GAAG,KAAK,IAAG;AACV,WAAO,IAAI,QAAQ,CAAC,SAAS,WAAS;AACrC,WAAK,QAAQ,OAAM,SAAM;AAExB,cAAM,MAAM,MAAMA,cAAG,MAAC,MAAM,KAAK,YAAW,EAAC,MAAK,IAAG,CAAC;AAKtD,cAAM,GAAG,GAAG;AACZ,YAAG,IAAI,QAAQ,GAAE;AAChB,eAAK,iBAAiB,IAAI,IAAI;AAC9B,kBAAQ,IAAI,KAAK,KAAK;AAAA,QAC3B,OAAS;AACJ,iBAAQ;AAAA,QACR;AAAA,MACL,CAAI;AAAA,IACJ,CAAG;AAAA,EACD;AAAA,EACD,iBAAiB,MAAK;AACrBA,kBAAAA,MAAI,MAAM,MAAM,SAAS,KAAK,KAAK;AACnCA,kBAAAA,MAAI,MAAM,MAAM,aAAa,KAAK,SAAS;AAC3CA,kBAAAA,MAAI,MAAM,MAAM,iBAAiB,KAAK,aAAa;AACnDA,kBAAAA,MAAI,MAAM,MAAM,YAAY,KAAK,QAAQ;AAAA,EACzC;AAAA;AAAA,EAGD,MAAM,WAAW,IAAG;AACnB,UAAM,QAAQA,cAAG,MAAC,MAAM,MAAM,OAAO;AACrC,UAAM,YAAYA,cAAG,MAAC,MAAM,MAAM,WAAW;AAC7C,QAAG,CAAC,SAAS,KAAK,IAAG,IAAG,MAAO,WAAU;AACxC,YAAM,KAAK;AACXA,oBAAAA,MAAA,MAAA,OAAA,yBAAY,cAAc;AAC1B,YAAM,GAAE;AACR,aAAO,QAAQ,QAAS;AAAA,IAC3B,OAAO;AACJ,YAAM,GAAE;AACR,aAAO,QAAQ,QAAS;AAAA,IACxB;AAAA,EACD;AAAA,EAED,WAAW,IAAG;AACb,SAAK,WAAW,MAAI;AACLA,0BAAI,MAAM,MAAM,OAAO;AACrC,YAAM,WAAWA,cAAG,MAAC,MAAM,MAAM,UAAU;AAC3C,UAAG,UAAS;AACX,cAAM,GAAE;AAAA,MACZ,OAAQ;AACJA,sBAAAA,MAAI,MAAM,MAAM,YAAW,MAAI;AAC9BA,8BAAI,MAAM,MAAM,gBAAgB;AAAA,QACrC,CAAK;AAAA,MACD;AAAA,IACJ,CAAG;AAAA,EACD;AAAA,EAED,SAAQ;AACPA,wBAAI,MAAM,YAAY,OAAO;AAC7BA,wBAAI,MAAM,YAAY,WAAW;AACjCA,wBAAI,MAAM,YAAY,eAAe;AACrCA,wBAAI,MAAM,YAAY,UAAU;AAAA,EAChC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AA2BF;;"}