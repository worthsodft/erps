{"version":3,"file":"choose-and-upload-file.js","sources":["uni_modules/uni-file-picker/components/uni-file-picker/choose-and-upload-file.js"],"sourcesContent":["'use strict';\r\n\r\nconst ERR_MSG_OK = 'chooseAndUploadFile:ok';\r\nconst ERR_MSG_FAIL = 'chooseAndUploadFile:fail';\r\n\r\nfunction chooseImage(opts) {\r\n\tconst {\r\n\t\tcount,\r\n\t\tsizeType = ['original', 'compressed'],\r\n\t\tsourceType,\r\n\t\textension\r\n\t} = opts\r\n\treturn new Promise((resolve, reject) => {\r\n\t\t// 微信由于旧接口不再维护，针对微信小程序平台改用chooseMedia接口\r\n\t\t// #ifdef MP-WEIXIN\r\n\t\tuni.chooseMedia({\r\n\t\t\tcount,\r\n\t\t\tsizeType,\r\n\t\t\tsourceType,\r\n\t\t\tmediaType: ['image'],\r\n\t\t\textension,\r\n\t\t\tsuccess(res) {\r\n\t\t\t\tres.tempFiles.forEach(item => {\r\n\t\t\t\t\titem.path = item.tempFilePath;\r\n\t\t\t\t})\r\n\t\t\t\tresolve(normalizeChooseAndUploadFileRes(res, 'image'));\r\n\t\t\t},\r\n\t\t\tfail(res) {\r\n\t\t\t\treject({\r\n\t\t\t\t\terrMsg: res.errMsg.replace('chooseImage:fail', ERR_MSG_FAIL),\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t})\r\n\t\t// #endif\r\n\t\t// #ifndef MP-WEIXIN\r\n\t\tuni.chooseImage({\r\n\t\t\tcount,\r\n\t\t\tsizeType,\r\n\t\t\tsourceType,\r\n\t\t\textension,\r\n\t\t\tsuccess(res) {\r\n\t\t\t\tresolve(normalizeChooseAndUploadFileRes(res, 'image'));\r\n\t\t\t},\r\n\t\t\tfail(res) {\r\n\t\t\t\treject({\r\n\t\t\t\t\terrMsg: res.errMsg.replace('chooseImage:fail', ERR_MSG_FAIL),\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t});\r\n\t\t// #endif\r\n\r\n\t});\r\n}\r\n\r\nfunction chooseVideo(opts) {\r\n\tconst {\r\n\t\tcount,\r\n\t\tcamera,\r\n\t\tcompressed,\r\n\t\tmaxDuration,\r\n\t\tsourceType,\r\n\t\textension\r\n\t} = opts;\r\n\treturn new Promise((resolve, reject) => {\r\n\t\t// 微信由于旧接口不再维护，针对微信小程序平台改用chooseMedia接口\r\n\t\t// #ifdef MP-WEIXIN\r\n\t\tuni.chooseMedia({\r\n\t\t\tcount,\r\n\t\t\tcompressed,\r\n\t\t\tmaxDuration,\r\n\t\t\tsourceType,\r\n\t\t\textension,\r\n\t\t\tmediaType: ['video'],\r\n\t\t\tsuccess(res) {\r\n\t\t\t\tconst {\r\n\t\t\t\t\ttempFiles,\r\n\t\t\t\t} = res;\r\n\t\t\t\tresolve(normalizeChooseAndUploadFileRes({\r\n\t\t\t\t\terrMsg: 'chooseVideo:ok',\r\n\t\t\t\t\ttempFiles: tempFiles.map(item => {\r\n\t\t\t\t\t\treturn {\r\n\t\t\t\t\t\t\tname: item.name || '',\r\n\t\t\t\t\t\t\tpath: item.tempFilePath,\r\n\t\t\t\t\t\t\tthumbTempFilePath: item.thumbTempFilePath,\r\n\t\t\t\t\t\t\tsize:item.size,\r\n\t\t\t\t\t\t\ttype: (res.tempFile && res.tempFile.type) || '',\r\n\t\t\t\t\t\t\twidth:item.width,\r\n\t\t\t\t\t\t\theight:item.height,\r\n\t\t\t\t\t\t\tduration:item.duration,\r\n\t\t\t\t\t\t\tfileType: 'video',\r\n\t\t\t\t\t\t\tcloudPath: '',\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}),\r\n\t\t\t\t}, 'video'));\r\n\t\t\t},\r\n\t\t\tfail(res) {\r\n\t\t\t\treject({\r\n\t\t\t\t\terrMsg: res.errMsg.replace('chooseVideo:fail', ERR_MSG_FAIL),\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t})\r\n\t\t// #endif\r\n\t\t// #ifndef MP-WEIXIN\r\n\t\tuni.chooseVideo({\r\n\t\t\tcamera,\r\n\t\t\tcompressed,\r\n\t\t\tmaxDuration,\r\n\t\t\tsourceType,\r\n\t\t\textension,\r\n\t\t\tsuccess(res) {\r\n\t\t\t\tconst {\r\n\t\t\t\t\ttempFilePath,\r\n\t\t\t\t\tduration,\r\n\t\t\t\t\tsize,\r\n\t\t\t\t\theight,\r\n\t\t\t\t\twidth\r\n\t\t\t\t} = res;\r\n\t\t\t\tresolve(normalizeChooseAndUploadFileRes({\r\n\t\t\t\t\terrMsg: 'chooseVideo:ok',\r\n\t\t\t\t\ttempFilePaths: [tempFilePath],\r\n\t\t\t\t\ttempFiles: [{\r\n\t\t\t\t\t\tname: (res.tempFile && res.tempFile.name) || '',\r\n\t\t\t\t\t\tpath: tempFilePath,\r\n\t\t\t\t\t\tsize,\r\n\t\t\t\t\t\ttype: (res.tempFile && res.tempFile.type) || '',\r\n\t\t\t\t\t\twidth,\r\n\t\t\t\t\t\theight,\r\n\t\t\t\t\t\tduration,\r\n\t\t\t\t\t\tfileType: 'video',\r\n\t\t\t\t\t\tcloudPath: '',\r\n\t\t\t\t\t}, ],\r\n\t\t\t\t}, 'video'));\r\n\t\t\t},\r\n\t\t\tfail(res) {\r\n\t\t\t\treject({\r\n\t\t\t\t\terrMsg: res.errMsg.replace('chooseVideo:fail', ERR_MSG_FAIL),\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t});\r\n\t\t// #endif\r\n\t});\r\n}\r\n\r\nfunction chooseAll(opts) {\r\n\tconst {\r\n\t\tcount,\r\n\t\textension\r\n\t} = opts;\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tlet chooseFile = uni.chooseFile;\r\n\t\tif (typeof wx !== 'undefined' &&\r\n\t\t\ttypeof wx.chooseMessageFile === 'function') {\r\n\t\t\tchooseFile = wx.chooseMessageFile;\r\n\t\t}\r\n\t\tif (typeof chooseFile !== 'function') {\r\n\t\t\treturn reject({\r\n\t\t\t\terrMsg: ERR_MSG_FAIL + ' 请指定 type 类型，该平台仅支持选择 image 或 video。',\r\n\t\t\t});\r\n\t\t}\r\n\t\tchooseFile({\r\n\t\t\ttype: 'all',\r\n\t\t\tcount,\r\n\t\t\textension,\r\n\t\t\tsuccess(res) {\r\n\t\t\t\tresolve(normalizeChooseAndUploadFileRes(res));\r\n\t\t\t},\r\n\t\t\tfail(res) {\r\n\t\t\t\treject({\r\n\t\t\t\t\terrMsg: res.errMsg.replace('chooseFile:fail', ERR_MSG_FAIL),\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t});\r\n\t});\r\n}\r\n\r\nfunction normalizeChooseAndUploadFileRes(res, fileType) {\r\n\tres.tempFiles.forEach((item, index) => {\r\n\t\tif (!item.name) {\r\n\t\t\titem.name = item.path.substring(item.path.lastIndexOf('/') + 1);\r\n\t\t}\r\n\t\tif (fileType) {\r\n\t\t\titem.fileType = fileType;\r\n\t\t}\r\n\t\titem.cloudPath =\r\n\t\t\tDate.now() + '_' + index + item.name.substring(item.name.lastIndexOf('.'));\r\n\t});\r\n\tif (!res.tempFilePaths) {\r\n\t\tres.tempFilePaths = res.tempFiles.map((file) => file.path);\r\n\t}\r\n\treturn res;\r\n}\r\n\r\nfunction uploadCloudFiles(files, max = 5, onUploadProgress) {\r\n\tfiles = JSON.parse(JSON.stringify(files))\r\n\tconst len = files.length\r\n\tlet count = 0\r\n\tlet self = this\r\n\treturn new Promise(resolve => {\r\n\t\twhile (count < max) {\r\n\t\t\tnext()\r\n\t\t}\r\n\r\n\t\tfunction next() {\r\n\t\t\tlet cur = count++\r\n\t\t\tif (cur >= len) {\r\n\t\t\t\t!files.find(item => !item.url && !item.errMsg) && resolve(files)\r\n\t\t\t\treturn\r\n\t\t\t}\r\n\t\t\tconst fileItem = files[cur]\r\n\t\t\tconst index = self.files.findIndex(v => v.uuid === fileItem.uuid)\r\n\t\t\tfileItem.url = ''\r\n\t\t\tdelete fileItem.errMsg\r\n\r\n\t\t\tuniCloud\r\n\t\t\t\t.uploadFile({\r\n\t\t\t\t\tfilePath: fileItem.path,\r\n\t\t\t\t\tcloudPath: fileItem.cloudPath,\r\n\t\t\t\t\tfileType: fileItem.fileType,\r\n\t\t\t\t\tonUploadProgress: res => {\r\n\t\t\t\t\t\tres.index = index\r\n\t\t\t\t\t\tonUploadProgress && onUploadProgress(res)\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t\t.then(res => {\r\n\t\t\t\t\tfileItem.url = res.fileID\r\n\t\t\t\t\tfileItem.index = index\r\n\t\t\t\t\tif (cur < len) {\r\n\t\t\t\t\t\tnext()\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t\t.catch(res => {\r\n\t\t\t\t\tfileItem.errMsg = res.errMsg || res.message\r\n\t\t\t\t\tfileItem.index = index\r\n\t\t\t\t\tif (cur < len) {\r\n\t\t\t\t\t\tnext()\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t}\r\n\t})\r\n}\r\n\r\n\r\n\r\n\r\n\r\nfunction uploadFiles(choosePromise, {\r\n\tonChooseFile,\r\n\tonUploadProgress\r\n}) {\r\n\treturn choosePromise\r\n\t\t.then((res) => {\r\n\t\t\tif (onChooseFile) {\r\n\t\t\t\tconst customChooseRes = onChooseFile(res);\r\n\t\t\t\tif (typeof customChooseRes !== 'undefined') {\r\n\t\t\t\t\treturn Promise.resolve(customChooseRes).then((chooseRes) => typeof chooseRes === 'undefined' ?\r\n\t\t\t\t\t\tres : chooseRes);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn res;\r\n\t\t})\r\n\t\t.then((res) => {\r\n\t\t\tif (res === false) {\r\n\t\t\t\treturn {\r\n\t\t\t\t\terrMsg: ERR_MSG_OK,\r\n\t\t\t\t\ttempFilePaths: [],\r\n\t\t\t\t\ttempFiles: [],\r\n\t\t\t\t};\r\n\t\t\t}\r\n\t\t\treturn res\r\n\t\t})\r\n}\r\n\r\nfunction chooseAndUploadFile(opts = {\r\n\ttype: 'all'\r\n}) {\r\n\tif (opts.type === 'image') {\r\n\t\treturn uploadFiles(chooseImage(opts), opts);\r\n\t} else if (opts.type === 'video') {\r\n\t\treturn uploadFiles(chooseVideo(opts), opts);\r\n\t}\r\n\treturn uploadFiles(chooseAll(opts), opts);\r\n}\r\n\r\nexport {\r\n\tchooseAndUploadFile,\r\n\tuploadCloudFiles\r\n};\r\n"],"names":["uni","wx","uniCloud"],"mappings":"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"}