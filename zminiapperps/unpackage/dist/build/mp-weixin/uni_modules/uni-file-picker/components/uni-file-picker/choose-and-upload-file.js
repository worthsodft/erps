"use strict";const e=require("../../../../common/vendor.js"),o="chooseAndUploadFile:fail";function i(e,o){return e.tempFiles.forEach(((e,i)=>{e.name||(e.name=e.path.substring(e.path.lastIndexOf("/")+1)),o&&(e.fileType=o),e.cloudPath=Date.now()+"_"+i+e.name.substring(e.name.lastIndexOf("."))})),e.tempFilePaths||(e.tempFilePaths=e.tempFiles.map((e=>e.path))),e}function t(e,{onChooseFile:o,onUploadProgress:i}){return e.then((e=>{if(o){const i=o(e);if(void 0!==i)return Promise.resolve(i).then((o=>void 0===o?e:o))}return e})).then((e=>!1===e?{errMsg:"chooseAndUploadFile:ok",tempFilePaths:[],tempFiles:[]}:e))}exports.chooseAndUploadFile=function(s={type:"all"}){return"image"===s.type?t(function(t){const{count:s,sizeType:n=["original","compressed"],sourceType:r,extension:a}=t;return new Promise(((t,l)=>{e.index.chooseMedia({count:s,sizeType:n,sourceType:r,mediaType:["image"],extension:a,success(e){e.tempFiles.forEach((e=>{e.path=e.tempFilePath})),t(i(e,"image"))},fail(e){l({errMsg:e.errMsg.replace("chooseImage:fail",o)})}})}))}(s),s):"video"===s.type?t(function(t){const{count:s,camera:n,compressed:r,maxDuration:a,sourceType:l,extension:c}=t;return new Promise(((t,n)=>{e.index.chooseMedia({count:s,compressed:r,maxDuration:a,sourceType:l,extension:c,mediaType:["video"],success(e){const{tempFiles:o}=e;t(i({errMsg:"chooseVideo:ok",tempFiles:o.map((o=>({name:o.name||"",path:o.tempFilePath,thumbTempFilePath:o.thumbTempFilePath,size:o.size,type:e.tempFile&&e.tempFile.type||"",width:o.width,height:o.height,duration:o.duration,fileType:"video",cloudPath:""})))},"video"))},fail(e){n({errMsg:e.errMsg.replace("chooseVideo:fail",o)})}})}))}(s),s):t(function(t){const{count:s,extension:n}=t;return new Promise(((t,r)=>{let a=e.index.chooseFile;if(void 0!==e.wx$1&&"function"==typeof e.wx$1.chooseMessageFile&&(a=e.wx$1.chooseMessageFile),"function"!=typeof a)return r({errMsg:o+" 请指定 type 类型，该平台仅支持选择 image 或 video。"});a({type:"all",count:s,extension:n,success(e){t(i(e))},fail(e){r({errMsg:e.errMsg.replace("chooseFile:fail",o)})}})}))}(s),s)},exports.uploadCloudFiles=function(o,i=5,t){const s=(o=JSON.parse(JSON.stringify(o))).length;let n=0,r=this;return new Promise((a=>{for(;n<i;)l();function l(){let i=n++;if(i>=s)return void(!o.find((e=>!e.url&&!e.errMsg))&&a(o));const c=o[i],p=r.files.findIndex((e=>e.uuid===c.uuid));c.url="",delete c.errMsg,e.nr.uploadFile({filePath:c.path,cloudPath:c.cloudPath,fileType:c.fileType,onUploadProgress:e=>{e.index=p,t&&t(e)}}).then((e=>{c.url=e.fileID,c.index=p,i<s&&l()})).catch((e=>{c.errMsg=e.errMsg||e.message,c.index=p,i<s&&l()}))}}))};
