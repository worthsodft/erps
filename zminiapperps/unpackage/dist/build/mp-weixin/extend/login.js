"use strict";const e=require("../common/vendor.js"),o={getCode(o){e.index.login({success(e){o&&o(e.code)}})},do(o,t){return new Promise(((n,i)=>{this.getCode((async a=>{const c=await e.index.$http.post("v1/login",{code:a,pid:o});t&&t(c),1==c.code?(this.updateTokenCache(c.data),n(c.data.token)):i()}))}))},updateTokenCache(o){e.index.$tool.cache("token",o.token),e.index.$tool.cache("expire_at",o.expire_at),e.index.$tool.cache("expire_at_txt",o.expire_at_txt),e.index.$tool.cache("is_phone",o.is_phone)},async judgeLogin(o){const t=e.index.$tool.cache("token"),n=e.index.$tool.cache("expire_at");return!t||Date.now()/1e3>n?(await this.do(),console.log("login.do(登录)"),o&&o(),Promise.resolve()):(o&&o(),Promise.resolve())},judgePhone(o){this.judgeLogin((()=>{e.index.$tool.cache("token");e.index.$tool.cache("is_phone")?o&&o():e.index.$tool.alert("请先完善用户信息",(()=>{e.index.$tool.navto("/pages/my/form")}))}))},logout(){e.index.$tool.removeCache("token"),e.index.$tool.removeCache("expire_at"),e.index.$tool.removeCache("expire_at_txt"),e.index.$tool.removeCache("is_phone")}};exports.login=o;
